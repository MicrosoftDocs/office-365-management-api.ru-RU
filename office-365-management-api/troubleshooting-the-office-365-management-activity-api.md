---
ms.technology: o365-service-communications
ms.TocTitle: Troubleshooting the Office 365 Management Activity API
title: Устранение неполадок, связанных с API действий управления Office 365
description: Сводка по наиболее распространенным вопросам об этом API, задаваемым службе поддержки Майкрософт.
ms.ContentId: 50822603-a1ec-a754-e7dc-67afe36bb1b0
ms.topic: reference (API)
ms.date: ''
localization_priority: Priority
ms.openlocfilehash: 323407799cefe74b331dec01bb746971c41b5adf
ms.sourcegitcommit: ec60dbd5990cfc61b8c000b423e7ade25fa613a8
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/09/2020
ms.locfileid: "48397435"
---
# <a name="office-365-management-activity-api-faqs-and-troubleshooting"></a><span data-ttu-id="341ed-103">Вопросы и ответы по API действий управления Office 365, а также устранение неполадок, связанных с ним</span><span class="sxs-lookup"><span data-stu-id="341ed-103">Office 365 Management Activity API FAQs and troubleshooting</span></span>

<span data-ttu-id="341ed-104">API действий управления Office 365 (другое название — *API единого аудита*), входящий в состав предложений для обеспечения безопасности и соответствия требованиям в Office 365:</span><span class="sxs-lookup"><span data-stu-id="341ed-104">The Office 365 Management Activity API (also known as the *Unified Auditing API*) is a part of Office 365 security and compliance offerings, that:</span></span>

- <span data-ttu-id="341ed-105">предоставляет программный доступ к нескольким рабочим нагрузкам конвейера аудита (например, SharePoint и Exchange);</span><span class="sxs-lookup"><span data-stu-id="341ed-105">Allows programmatic access to multiple auditing pipeline workloads (such as SharePoint and Exchange)</span></span>

- <span data-ttu-id="341ed-106">является основным интерфейсом, который используют различные продукты от сторонних поставщиков, чтобы агрегировать и индексировать данные аудита.</span><span class="sxs-lookup"><span data-stu-id="341ed-106">Is the main interface used by a variety of third-party vendor products to aggregate and index auditing data</span></span>

<span data-ttu-id="341ed-107">API действий управления не следует путать с API связи со службой Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-107">The Management Activity API shouldn't be confused with the Office 365 Service Communications API.</span></span> <span data-ttu-id="341ed-108">API действий управления используется для аудита действий пользователей в различных рабочих нагрузках.</span><span class="sxs-lookup"><span data-stu-id="341ed-108">The Management Activity API is for auditing end user activities in the various workloads.</span></span> <span data-ttu-id="341ed-109">API связи со службой предназначен для аудита состояния и сообщений, отправляемых службами, которые доступны в Office 365 (например, Dynamics CRM или службой идентификации).</span><span class="sxs-lookup"><span data-stu-id="341ed-109">The Service Communications API is for auditing status and messages that are sent by the services that are available in Office 365 (such as Dynamics CRM or Identity Service).</span></span>

## <a name="frequently-asked-questions-about-the-office-365-management-activity-api"></a><span data-ttu-id="341ed-110">API действий управления Office 365: вопросы и ответы</span><span class="sxs-lookup"><span data-stu-id="341ed-110">Frequently asked questions about the Office 365 Management Activity API</span></span>

<span data-ttu-id="341ed-111">**Каков максимальный период ожидания отправки уведомления о том или ином событии Office 365?**</span><span class="sxs-lookup"><span data-stu-id="341ed-111">**What is the maximum time I will have to wait before a notification is sent about a given Office 365 event?**</span></span>

<span data-ttu-id="341ed-112">Не существует гарантированной максимальной задержки для доставки уведомлений (другими словами, отсутствует соглашение об уровне обслуживания).</span><span class="sxs-lookup"><span data-stu-id="341ed-112">There is no guaranteed maximum latency for notification delivery (in other words, no SLA).</span></span> <span data-ttu-id="341ed-113">Служба поддержки Майкрософт отмечает, что большинство уведомлений отправляются в течение одного часа после события.</span><span class="sxs-lookup"><span data-stu-id="341ed-113">Microsoft Support's experience has been that most notifications are sent within one hour of the event.</span></span> <span data-ttu-id="341ed-114">Зачастую задержка намного меньше, но она часто бывает и больше.</span><span class="sxs-lookup"><span data-stu-id="341ed-114">Often the latency is much shorter, but often it's longer as well.</span></span> <span data-ttu-id="341ed-115">Это в той или иной степени зависит от конкретной рабочей нагрузки, но в целом большинство уведомлений доставляются в течение 24 часов после соответствующего события.</span><span class="sxs-lookup"><span data-stu-id="341ed-115">This varies somewhat from workload to workload, but a general rule is that most notifications will be delivered within 24 hours of the originating event.</span></span>

<span data-ttu-id="341ed-116">**Не отправляются ли уведомления веб-перехватчиков быстрее? Разве они не управляются событиями?**</span><span class="sxs-lookup"><span data-stu-id="341ed-116">**Aren't webhook notifications more immediate? After all, aren't they are event-driven?**</span></span>

<span data-ttu-id="341ed-117">Нет.</span><span class="sxs-lookup"><span data-stu-id="341ed-117">No.</span></span><span data-ttu-id="341ed-118">Уведомления веб-перехватчиков не создаются автоматически сразу после появления событий.</span><span class="sxs-lookup"><span data-stu-id="341ed-118"> Webhook notifications aren't event-driven in the sense that the event triggers the notification.</span></span> <span data-ttu-id="341ed-119">Необходимо создать большой двоичный объект контента, что приводит к доставке уведомлений.</span><span class="sxs-lookup"><span data-stu-id="341ed-119">The content blob must still be created and creating the content blob is what triggers the notification delivery.</span></span> <span data-ttu-id="341ed-120">В последнее время период ожидания уведомлений при использовании веб-перехватчиков был дольше, чем в случае отправки API запросов непосредственно с помощью операции /content.</span><span class="sxs-lookup"><span data-stu-id="341ed-120">Recently, there have been longer wait times for notifications when using a webhook compared to querying the API directly with the /content operation.</span></span> <span data-ttu-id="341ed-121">Следовательно, API действий управления не стоит рассматривать как систему оповещений о событиях безопасности в режиме реального времени.</span><span class="sxs-lookup"><span data-stu-id="341ed-121">Therefore, the Management Activity API shouldn't be thought of as a real-time security alert system.</span></span> <span data-ttu-id="341ed-122">Корпорация Майкрософт предлагает для этого другие продукты.</span><span class="sxs-lookup"><span data-stu-id="341ed-122">Microsoft has other products for that.</span></span> <span data-ttu-id="341ed-123">С точки зрения безопасности уведомления о событиях, получаемые с помощью API действий управления, больше подходят для определения тенденций использования за длительные периоды.</span><span class="sxs-lookup"><span data-stu-id="341ed-123">As far as security is concerned, Management Activity API event notifications can more appropriately be used to determine use patterns over extended periods of time.</span></span>

<span data-ttu-id="341ed-124">**Можно ли запросить у API действий управления определенный ИД события, RecordType или другие свойства большого двоичного объекта контента?**</span><span class="sxs-lookup"><span data-stu-id="341ed-124">**Can I query the Management Activity API for a particular event ID or RecordType or other properties in the content blob?**</span></span>

<span data-ttu-id="341ed-125">Нет.</span><span class="sxs-lookup"><span data-stu-id="341ed-125">No.</span></span><span data-ttu-id="341ed-126">Не следует рассматривать данные, доступные через API действий управления, как "журнал" в традиционном смысле этого слова.</span><span class="sxs-lookup"><span data-stu-id="341ed-126"> Don't think of the data available through the Management Activity API as being a “log” in the traditional sense.</span></span> <span data-ttu-id="341ed-127">Правильнее считать его дампом сведений о событиях.</span><span class="sxs-lookup"><span data-stu-id="341ed-127">Rather, think of it as a dump of event details.</span></span> <span data-ttu-id="341ed-128">Вам остается собрать все эти сведения о событиях, хранить и индексировать их в локальной среде, а затем реализовать собственную логику запросов, используя либо собственное приложение, либо стороннее средство.</span><span class="sxs-lookup"><span data-stu-id="341ed-128">It's up to you to gather all those event details, store and index them locally, and then implement your own query logic, by using either a custom application or a third-party tool.</span></span>

<span data-ttu-id="341ed-129">**Как убедиться, что данные, поступающие из имеющегося решения для аудита, которое собирает данные из API действий управления, являются точными и полными?**</span><span class="sxs-lookup"><span data-stu-id="341ed-129">**How do I know the data coming from my existing auditing solution, which collects data from the Management Activity API, is accurate and complete?**</span></span>

<span data-ttu-id="341ed-130">Краткий ответ — корпорация Майкрософт не предоставляет никакого журнала, позволяющего проверить то или иное приложение либо стороннее решение.</span><span class="sxs-lookup"><span data-stu-id="341ed-130">The short answer is that Microsoft doesn't provide any kind of a log that will allow you to cross-check any given application or third-party (ISV) application.</span></span> <span data-ttu-id="341ed-131">Существуют другие продукты от Майкрософт для обеспечения безопасности, которые получают свои данные из того же конвейера, но эти продукты не имеют отношения к данной теме, и с их помощью невозможно непосредственно проверить API действий управления.</span><span class="sxs-lookup"><span data-stu-id="341ed-131">There are other Microsoft security products that draw their data from the same pipeline, but those products fall outside the scope of this discussion and can't be used to directly cross-check the Management Activity API.</span></span> <span data-ttu-id="341ed-132">Если вас беспокоят несоответствия между данными, которые предоставляет имеющееся решение, и вашими ожиданиями, вам следует реализовать показанные выше операции.</span><span class="sxs-lookup"><span data-stu-id="341ed-132">If you're concerned about discrepancies between what your existing solution is providing and what you expect, you should implement the operations illustrated above.</span></span> <span data-ttu-id="341ed-133">Однако это может быть сложно в зависимости от того, как имеющееся средство или решение перечисляет и индексирует данные.</span><span class="sxs-lookup"><span data-stu-id="341ed-133">But this can be difficult, depending on how your existing tool or solution lists and indexes data.</span></span> <span data-ttu-id="341ed-134">Если имеющееся решение только представляет данные, отсортированные по времени создания самого события, то запросить у API события по времени их создания для последующего сравнения будет невозможно.</span><span class="sxs-lookup"><span data-stu-id="341ed-134">If your existing solution only presents data sorted by the creation time of the actual event, there's no way to query the API by event creation time so that you could compare result sets.</span></span> <span data-ttu-id="341ed-135">В этом случае вам придется собирать нужные объекты контента в течение нескольких дней, индексировать или сортировать их вручную, а затем выполнять приблизительное сравнение.</span><span class="sxs-lookup"><span data-stu-id="341ed-135">In this scenario, you'd have to collect the notified content blobs for several days, index or sort them manually, and then do a rough comparison.</span></span>

<span data-ttu-id="341ed-136">**Как долго объекты контента будут оставаться доступными?**</span><span class="sxs-lookup"><span data-stu-id="341ed-136">**How long will the content blobs remain available?**</span></span>

<span data-ttu-id="341ed-137">Большие двоичные объекты с контентом доступны в течение 7 дней после отправки уведомлений об их появлении.</span><span class="sxs-lookup"><span data-stu-id="341ed-137">Content blobs are available 7 days after the notification of the content blob's availability.</span></span> <span data-ttu-id="341ed-138">Это означает, что если при создании объекта с контентом существует значительная задержка, то у вас будет больше времени (задержка плюс 7 дней) после фактической даты события, пока этот объект не перестанет быть доступным.</span><span class="sxs-lookup"><span data-stu-id="341ed-138">This means that if there is a significant delay in the creation of the content blob, you will have more time (the delay plus 7 days) after the actual event creation date before the content blob is no longer available.</span></span>

<span data-ttu-id="341ed-139">**Если уведомления приходят с 24-часовой задержкой, не значит ли это, что у меня остается только 6 дней, чтобы получить объект с контентом?**</span><span class="sxs-lookup"><span data-stu-id="341ed-139">**If there is a 24-hour delay in getting a notification, doesn't that mean I will have only 6 days to retrieve the content blob?**</span></span>

<span data-ttu-id="341ed-140">Нет.</span><span class="sxs-lookup"><span data-stu-id="341ed-140">No.</span></span><span data-ttu-id="341ed-141">Даже если уведомление задерживается на непривычно долгое время (например, при перебоях в работе службы), у вас все равно останется 7 дней после появления уведомления, чтобы скачать объект, связанный с первоначальным событием.</span><span class="sxs-lookup"><span data-stu-id="341ed-141"> Even if the notification is delayed for an unusually long period (for example, in the case of a service interruption), you would still have 7 days after the first availability of the notification to download the content blob related to the originating event.</span></span>

<span data-ttu-id="341ed-142">**В случае каких событий проводится аудит для определенной службы Office 365?**</span><span class="sxs-lookup"><span data-stu-id="341ed-142">**What events are audited for a specific Office 365 service?**</span></span>

<span data-ttu-id="341ed-143">В документации по схеме API действий управления Office 365 приведен полный список событий.</span><span class="sxs-lookup"><span data-stu-id="341ed-143">Office 365 Management Activity API schema documentation has a comprehensive list of events.</span></span> <span data-ttu-id="341ed-144">Дополнительные сведения см. в статье "Схема API действий управления Office 365".</span><span class="sxs-lookup"><span data-stu-id="341ed-144">For details, see Office 365 Management Activity API schema.</span></span> <span data-ttu-id="341ed-145">Кроме того, в статье "Поиск по журналу аудита в Центре безопасности и соответствия требованиям" в разделе "Подлежащие аудиту действия" приводится список событий для большинства служб Office 365, которые подлежат аудиту.</span><span class="sxs-lookup"><span data-stu-id="341ed-145">Also see the “Audited activities” section in Search the audit log in the Security & Compliance Center for a list of events for most of the Office 365 services that are audited.</span></span>

<span data-ttu-id="341ed-146">**Как подключиться к API действий управления?**</span><span class="sxs-lookup"><span data-stu-id="341ed-146">**How do I onboard to the Management Activity API?**</span></span>

<span data-ttu-id="341ed-147">Сведения о том, как начать работу с API действий управления Office 365, см. в статье "Начало работы с API управления Office 365".</span><span class="sxs-lookup"><span data-stu-id="341ed-147">To get started with the Office 365 Management Activity API, see Get started with Office 365 Management APIs.</span></span>

<span data-ttu-id="341ed-148">**Мы хотим программным способом собирать данные обо всех событиях во всех рабочих нагрузках. Как это лучше сделать?**</span><span class="sxs-lookup"><span data-stu-id="341ed-148">**We want to programmatically capture all events in all workloads. What is the most reliable way to do this?**</span></span>

<span data-ttu-id="341ed-149">Это можно сделать, используя API действий управления Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-149">You can do this by using the Office 365 Management Activity API.</span></span> <span data-ttu-id="341ed-150">Рекомендуем также использовать **модель извлечения**, так как с веб-перехватчиками возникают проблемы.</span><span class="sxs-lookup"><span data-stu-id="341ed-150">Also, we recommend that you use the **pull model** due to issues with using webhooks.</span></span> <span data-ttu-id="341ed-151">Дополнительные сведения см. в статье "Устранение неполадок, связанных с API действий управления Office 365" в разделе "Использование веб-перехватчиков".</span><span class="sxs-lookup"><span data-stu-id="341ed-151">For more information, see the “Using webhooks” section in Troubleshooting the Office 365 Management Activity API.</span></span>

<span data-ttu-id="341ed-152">**Есть ли разница между записями, которые получены API действий управления, и записями, которые возвращены средством поиска в журналах аудита, доступным в Центре соответствия требованиям Microsoft 365?**</span><span class="sxs-lookup"><span data-stu-id="341ed-152">**Are there any differences in the records that are fetched by the Management Activity API versus the records that are returned by using the audit log search tool in the Microsoft 365 compliance center?**</span></span>

<span data-ttu-id="341ed-153">В обоих случаях возвращаются одни и те же данные.</span><span class="sxs-lookup"><span data-stu-id="341ed-153">The data that is returned by both methods is the same.</span></span> <span data-ttu-id="341ed-154">Фильтрация не выполняется.</span><span class="sxs-lookup"><span data-stu-id="341ed-154">There is no filtering that happens.</span></span> <span data-ttu-id="341ed-155">Единственное отличие заключается в том, что с помощью API за один подход можно получить данные за последние 7 дней.</span><span class="sxs-lookup"><span data-stu-id="341ed-155">The only difference is that with the API, you can get data for the last 7 days at a time.</span></span> <span data-ttu-id="341ed-156">При поиске в журнале аудита в Центре безопасности и соответствия требованиям (или при использовании соответствующего командлета Search-UnifiedAuditLog в Exchange Online) можно получить данные за последние 90 дней.</span><span class="sxs-lookup"><span data-stu-id="341ed-156">When searching the audit log in the Security & Compliance Center (or by using the corresponding Search-UnifiedAuditLog cmdlet in Exchange Online), you can get data for the last 90 days.</span></span>

<span data-ttu-id="341ed-157">**Что произойдет, если я отключу аудит для своей организации Office 365? Буду ли я по-прежнему получать события через API действий управления?**</span><span class="sxs-lookup"><span data-stu-id="341ed-157">**What happens if I disable auditing for my Office 365 organization? Will I still get events via the Management Activity API?**</span></span>

<span data-ttu-id="341ed-158">Нет.</span><span class="sxs-lookup"><span data-stu-id="341ed-158">No.</span></span><span data-ttu-id="341ed-159">Чтобы получать записи через API действий управления, необходимо включить единый аудит Office 365 для своей организации.</span><span class="sxs-lookup"><span data-stu-id="341ed-159"> Office 365 unified auditing must be enabled for your organization to pull records via the Management Activity API.</span></span> <span data-ttu-id="341ed-160">Инструкции см. в статье "Включение и отключение поиска в журнале аудита Office 365".</span><span class="sxs-lookup"><span data-stu-id="341ed-160">For instructions, see Turn Office 365 audit log search on or off.</span></span>

<span data-ttu-id="341ed-161">**Каково ограничение на регулирование для API действий управления?**</span><span class="sxs-lookup"><span data-stu-id="341ed-161">**What is the throttling limit for the Management Activity API?**</span></span>

<span data-ttu-id="341ed-162">Для всех организаций изначально выделяется базовый уровень 2 000 запросов в минуту.</span><span class="sxs-lookup"><span data-stu-id="341ed-162">All organizations are initially allocated a baseline of 2,000 requests per minute.</span></span> <span data-ttu-id="341ed-163">Этот предел не статический, предварительно определенный, а моделирующийся на основе сочетания факторов, включая число рабочих мест в организации, а также тот факт, что организации Office 365 E5 и Microsoft 365 E5 получат вдвое большую пропускную способность по сравнению с организациями без плана E5.</span><span class="sxs-lookup"><span data-stu-id="341ed-163">This is not a static, predefined limit but is modeled on a combination of factors including the number of seats in the organization and the fact that Office 365 E5 and Microsoft 365 E5 organizations will get approximately twice as much bandwidth as non-E5 organizations.</span></span> <span data-ttu-id="341ed-164">Для защиты работоспособности службы также будет использоваться ограничение максимальной пропускной способности.</span><span class="sxs-lookup"><span data-stu-id="341ed-164">There will also be cap on the maximum bandwidth to protect the health of the service.</span></span>

> [!NOTE]
> <span data-ttu-id="341ed-165">Хотя каждый клиент может изначально отправлять до 2 000 запросов в минуту, корпорация Майкрософт не может гарантировать скорость отклика.</span><span class="sxs-lookup"><span data-stu-id="341ed-165">Even though each tenant can initially submit up to 2,000 requests per minute, Microsoft cannot guarantee a response rate.</span></span> <span data-ttu-id="341ed-166">Она зависит от различных факторов, таких как производительность клиентской системы, а также мощность и скорость сети.</span><span class="sxs-lookup"><span data-stu-id="341ed-166">The response rate depends on various factors, such as client system performance, network capacity, and network speed.</span></span>

<span data-ttu-id="341ed-167">**У меня возникла ошибка регулирования в API действий управления. Что мне делать?**</span><span class="sxs-lookup"><span data-stu-id="341ed-167">**I'm encountering a throttling error in the Management Activity API. What should I do?**</span></span>

<span data-ttu-id="341ed-168">Отправьте запрос в службу поддержки Майкрософт на увеличение максимального значения для регулирования, указав для этого коммерческое обоснование.</span><span class="sxs-lookup"><span data-stu-id="341ed-168">Open a ticket with Microsoft Support and request a new throttling limit, and include a business justification for increasing the limit.</span></span> <span data-ttu-id="341ed-169">Мы проанализируем запрос и в случае положительного решения увеличим максимальное значение для регулирования.</span><span class="sxs-lookup"><span data-stu-id="341ed-169">We will evaluate the request, and if accepted, we will increase the throttling limit.</span></span>

<span data-ttu-id="341ed-170">**Почему TargetUpdatedProperties больше не находятся в свойстве ExtendedProperties в журналах аудита для действий Azure Active Directory?**</span><span class="sxs-lookup"><span data-stu-id="341ed-170">**Why are TargetUpdatedProperties no longer in ExtendedProperties in the audit logs for Azure Active Directory activities?**</span></span>

<span data-ttu-id="341ed-171">TargetUpdatedProperties отображались в объекте ExtendedProperties.</span><span class="sxs-lookup"><span data-stu-id="341ed-171">TargetUpdatedProperties were appearing in ExtendedProperties.</span></span> <span data-ttu-id="341ed-172">Однако они были удалены из свойства ExtendedProperties и теперь отображаются в свойстве ModifiedProperties.</span><span class="sxs-lookup"><span data-stu-id="341ed-172">However, they have been removed from ExtendedProperties and now appear in ModifiedProperties.</span></span>

## <a name="troubleshooting-the-office-365-management-activity-api"></a><span data-ttu-id="341ed-173">Устранение неполадок, связанных с API действий управления Office 365</span><span class="sxs-lookup"><span data-stu-id="341ed-173">Troubleshooting the Office 365 Management Activity API</span></span>

<span data-ttu-id="341ed-174">Каждому, кто начинает работать с API действий управления Office 365, следует понимать, что в этом интерфейсе отсутствует возможность запрашивать события по конкретным характеристикам, например дате события, семейству веб-сайтов, в котором оно произошло, или типу события.</span><span class="sxs-lookup"><span data-stu-id="341ed-174">One thing that should be made clear for anyone who's getting started with the Office 365 Management Activity API is that there is no concept of querying by event specifics, such as date that the event occurred, which site collection an event might have been fired from, or the type of event.</span></span> <span data-ttu-id="341ed-175">Вместо этого создаются подписки на определенные рабочие нагрузки (например, SharePoint или Azure AD), по одной на клиент.</span><span class="sxs-lookup"><span data-stu-id="341ed-175">Instead, you create subscriptions to specific workloads (for example, SharePoint or Azure AD) and each subscription is per tenant.</span></span>

<span data-ttu-id="341ed-176">В следующих разделах рассматриваются наиболее распространенные вопросы клиентов, которые возникают при использовании API действий управления Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-176">The following sections summarizes the most common questions that customers have in using the Office 365 Management Activity API:</span></span>

- [<span data-ttu-id="341ed-177">Вопросы о сторонних средствах и клиентах</span><span class="sxs-lookup"><span data-stu-id="341ed-177">Questions about third-party tools and clients</span></span>](#questions-about-third-party-tools-and-clients)

- [<span data-ttu-id="341ed-178">Включение ведения единого журнала аудита в Office 365</span><span class="sxs-lookup"><span data-stu-id="341ed-178">Enabling unified audit logging in Office 365</span></span>](#enabling-unified-audit-logging-in-office-365)

- [<span data-ttu-id="341ed-179">Подключение к API</span><span class="sxs-lookup"><span data-stu-id="341ed-179">Connecting to the API</span></span>](#connecting-to-the-api)

- [<span data-ttu-id="341ed-180">Проверка подписок</span><span class="sxs-lookup"><span data-stu-id="341ed-180">Checking your subscriptions</span></span>](#checking-your-subscriptions)

- [<span data-ttu-id="341ed-181">Создание новой подписки</span><span class="sxs-lookup"><span data-stu-id="341ed-181">Creating a new subscription</span></span>](#creating-a-new-subscription)

- [<span data-ttu-id="341ed-182">Использование веб-перехватчиков</span><span class="sxs-lookup"><span data-stu-id="341ed-182">Using webhooks</span></span>](#using-webhooks)

- [<span data-ttu-id="341ed-183">Запрос больших двоичных объектов с контентом и регулирование</span><span class="sxs-lookup"><span data-stu-id="341ed-183">Requesting content blobs and throttling</span></span>](#requesting-content-blobs-and-throttling)

<span data-ttu-id="341ed-184">Мы покажем подборку простых скриптов PowerShell, которая может помочь вам найти ответы на наиболее распространенные вопросы пользователей и начать реализовывать собственное решение с использованием основных операций.</span><span class="sxs-lookup"><span data-stu-id="341ed-184">We'll show a selection of simple PowerShell scripts that can help you answer the most common questions asked by customers or get you started implementing a custom solution by demonstrating the main operations.</span></span> <span data-ttu-id="341ed-185">В этих разделах описываются не все операции, но их полный список представлен в статье "Справочник по API действий управления Office 365".</span><span class="sxs-lookup"><span data-stu-id="341ed-185">Not all the operations are explained in these sections, but they are all listed in Office 365 Management Activity API reference.</span></span>

### <a name="questions-about-third-party-tools-and-clients"></a><span data-ttu-id="341ed-186">Вопросы о сторонних средствах и клиентах</span><span class="sxs-lookup"><span data-stu-id="341ed-186">Questions about third-party tools and clients</span></span>

<span data-ttu-id="341ed-187">Наиболее распространенная категория вопросов пользователей связана с использованием сторонних продуктов для скачивания и агрегирования данных аудита.</span><span class="sxs-lookup"><span data-stu-id="341ed-187">The most common category of questions come from customers using third-party products to download and aggregate auditing data.</span></span> <span data-ttu-id="341ed-188">В зависимости от стороннего продукта, у пользователей могут возникать трудности с настройкой либо перебои или несоответствия данных, предоставляемых в этих продуктах.</span><span class="sxs-lookup"><span data-stu-id="341ed-188">Depending on the third-party product, customers may encounter difficulty with the setup or experience an interruption or an inconsistency in the data exposed in those products.</span></span> <span data-ttu-id="341ed-189">Тут следует отметить, что первое действие, которое следует предпринять таким клиентам, — обратиться в службу поддержки поставщика соответствующего продукта.</span><span class="sxs-lookup"><span data-stu-id="341ed-189">Here it should be stated that the first action such customers should take is to contact their vendor's support organization.</span></span> <span data-ttu-id="341ed-190">Как правило, причиной жалоб клиента является проблема со службой или конфигурацией поставщика для определенного клиента.</span><span class="sxs-lookup"><span data-stu-id="341ed-190">Typically, a tenant-specific vendor configuration or service problem is the cause of customer complaints.</span></span>

### <a name="enabling-unified-audit-logging-in-office-365"></a><span data-ttu-id="341ed-191">Включение ведения единого журнала аудита в Office 365</span><span class="sxs-lookup"><span data-stu-id="341ed-191">Enabling unified audit logging in Office 365</span></span>

<span data-ttu-id="341ed-192">Если вы только что настроили приложение, пытающееся использовать API действий управления, но оно не работает, убедитесь, что включено ведение единого журнала аудита для организации Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-192">If you've just set up an app that's trying to use the Management Activity API and it's not working, be sure that you've enabled unified audit logging for your Office 365 organization.</span></span> <span data-ttu-id="341ed-193">Это выполняется путем включения журнала аудита Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-193">You do this by turning on the Office 365 audit log.</span></span> <span data-ttu-id="341ed-194">Инструкции см. в статье [Включение и отключение поиска в журнале аудита Office 365](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span><span class="sxs-lookup"><span data-stu-id="341ed-194">For instructions, see [Turn Office 365 audit log search on or off](https://docs.microsoft.com/office365/securitycompliance/turn-audit-log-search-on-or-off).</span></span>

<span data-ttu-id="341ed-195">Если единый аудит не включен, как правило, вы будете получать сообщение об ошибке со следующей строкой: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span><span class="sxs-lookup"><span data-stu-id="341ed-195">If unified auditing isn't enabled, you will typically receive an error that contains the following string: `Microsoft.Office.Compliance.Audit``.DataServiceException: Tenant <tenantID> does not exist.`</span></span>

### <a name="connecting-to-the-api"></a><span data-ttu-id="341ed-196">Подключение к API</span><span class="sxs-lookup"><span data-stu-id="341ed-196">Connecting to the API</span></span>

<span data-ttu-id="341ed-197">Большинство приложений подключаются к API с помощью обычного потока OAuth2 учетных данных клиента.</span><span class="sxs-lookup"><span data-stu-id="341ed-197">Most applications connect to the API using a straightforward Client Credentials OAuth2 flow.</span></span> <span data-ttu-id="341ed-198">Следовательно, для начала необходимо создать приложение Azure AD с разрешениями, необходимыми для доступа к данным API действий управления.</span><span class="sxs-lookup"><span data-stu-id="341ed-198">Therefore, the first step is to create an Azure AD application that has the permissions needed to access the Management Activity API data.</span></span> <span data-ttu-id="341ed-199">В этой статье не представлены инструкции по регистрации приложения Azure AD.</span><span class="sxs-lookup"><span data-stu-id="341ed-199">It's outside the scope of this article to explain the steps to create an Azure AD App registration.</span></span> <span data-ttu-id="341ed-200">Дополнительные сведения см. в статье [Краткое руководство. Регистрация приложения в конечной точке Azure Active Directory](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span><span class="sxs-lookup"><span data-stu-id="341ed-200">For more information, see [Register your application with your Azure Active Directory tenant](https://docs.microsoft.com/azure/active-directory/develop/active-directory-integrating-applications).</span></span>

#### <a name="azure-application-permissions"></a><span data-ttu-id="341ed-201">Разрешения приложений Azure</span><span class="sxs-lookup"><span data-stu-id="341ed-201">Azure application permissions</span></span>

<span data-ttu-id="341ed-202">В настоящее время для API действий управления Office 365 используются следующие три разрешения:</span><span class="sxs-lookup"><span data-stu-id="341ed-202">The three permissions currently used for the Office 365 Management Activity API are:</span></span>

1. <span data-ttu-id="341ed-203">чтение данных о действиях в организации;</span><span class="sxs-lookup"><span data-stu-id="341ed-203">Read activity data for your organization</span></span>

2. <span data-ttu-id="341ed-204">чтение сведений о работоспособности служб в организации;</span><span class="sxs-lookup"><span data-stu-id="341ed-204">Read service health information for your organization</span></span>

3. <span data-ttu-id="341ed-205">чтение событий политик защиты от потери данных (DLP), в том числе при обнаружении конфиденциальной информации.</span><span class="sxs-lookup"><span data-stu-id="341ed-205">Read Data Loss Prevention (DLP) policy events, including detected sensitive information</span></span>

> [!NOTE]
> <span data-ttu-id="341ed-206">Необходимо включить как разрешения приложений, так и делегированные разрешения по крайней мере для первых двух из вышеуказанных наборов разрешений.</span><span class="sxs-lookup"><span data-stu-id="341ed-206">You should enable both the Application Permissions and the Delegated Permissions for at least the first two of the above permission sets.</span></span> <span data-ttu-id="341ed-207">Чтение событий политик защиты от потери данных потребуется, только если вас интересуют рабочие нагрузки DLP.</span><span class="sxs-lookup"><span data-stu-id="341ed-207">Read DLP policy events will only be necessary if you are interested in the DLP workloads.</span></span>

#### <a name="getting-an-access-token"></a><span data-ttu-id="341ed-208">Получение маркера доступа</span><span class="sxs-lookup"><span data-stu-id="341ed-208">Getting an access token</span></span>

<span data-ttu-id="341ed-209">В приведенном ниже скрипте PowerShell используются идентификатор приложения и секрет клиента, чтобы получить токен OAuth2 из конечной точки проверки подлинности для API действий управления.</span><span class="sxs-lookup"><span data-stu-id="341ed-209">The following PowerShell script uses the App ID and a Client Secret to obtain the OAuth2 token from the Management Activity API authentication endpoint.</span></span> <span data-ttu-id="341ed-210">Затем маркер доступа помещается в переменную массива `$headerParams`, которую вы вложите в свой HTTP-запрос.</span><span class="sxs-lookup"><span data-stu-id="341ed-210">It then places the access token into the `$headerParams` array variable, which you'll attach to your HTTP request.</span></span> <span data-ttu-id="341ed-211">В качестве значения конечной точки API (в переменной $resource) используйте одно из указанных ниже значений в зависимости от плана подписки на Microsoft 365 или Office 365:</span><span class="sxs-lookup"><span data-stu-id="341ed-211">For the value for the API endpoint (in the $resource variable) use one of the following values based on your organization's Microsoft 365 or Office 365 subscription plan:</span></span>

- <span data-ttu-id="341ed-212">План для предприятий: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="341ed-212">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="341ed-213">План для государственных организаций (GCC): `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="341ed-213">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="341ed-214">План для государственных организаций (GCC High): `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="341ed-214">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="341ed-215">План для государственных организаций (DoD): `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="341ed-215">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
# Create app of type Web app / API in Azure AD, generate a Client Secret, and update the client id and client secret here
$ClientID = "<YOUR_APPLICATION_ID"
$ClientSecret = "<YOUR_CLIENT_SECRET>"
$loginURL = "https://login.microsoftonline.com/"
$tenantdomain = "<YOUR_DOMAIN>.onmicrosoft.com"
# Get the tenant GUID from Properties | Directory ID under the Azure Active Directory section. For $resource, use one of these endpoint values based on your subscription plan: Enterprise - manage.office.com; GCC - manage-gcc.office.com; GCC High: manage.office365.us; DoD: manage.protection.apps.mil
$TenantGUID = "<YOUR_TENANT_GUID>"
$resource = "https://<YOUR_API_ENDPOINT>"
# auth
$body = @{grant_type="client_credentials";resource=$resource;client_id=$ClientID;client_secret=$ClientSecret}
$oauth = Invoke-RestMethod -Method Post -Uri $loginURL/$tenantdomain/oauth2/token?api-version=1.0 -Body $body
$headerParams = @{'Authorization'="$($oauth.token_type) $($oauth.access_token)"} 
```

<span data-ttu-id="341ed-216">Переменная `$oauth` будет содержать объект отклика, у которого есть ряд свойств, в том числе маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="341ed-216">The `$oauth` variable will contain the response object, which has several properties including the access token.</span></span> <span data-ttu-id="341ed-217">Вот пример такого отклика:</span><span class="sxs-lookup"><span data-stu-id="341ed-217">Here's an example of a response:</span></span>

```json
token_type     : Bearer
expires_in     : 3599
ext_expires_in : 0
expires_on     : 1508285860
not_before     : 1508281960
resource       : https://manage.office.com
access_token   : eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyIsImtpZCI6IjJLVmN1enFBaWRPTHFXU2FvbDd3Z0ZSR0NZbyJ9.eyJhdWQiOiJodHRwczov…
```

### <a name="checking-your-subscriptions"></a><span data-ttu-id="341ed-218">Проверка подписок</span><span class="sxs-lookup"><span data-stu-id="341ed-218">Checking your subscriptions</span></span>

<span data-ttu-id="341ed-219">Если произойдет перебой потока данных в имеющиеся клиент или решение, использующие API действий управления, вы можете подумать, что с вашей подпиской что-то не так.</span><span class="sxs-lookup"><span data-stu-id="341ed-219">If you've experienced an interruption in data flowing to an existing Management Activity API client or solution, you might wonder if something happened to your subscription.</span></span> <span data-ttu-id="341ed-220">Чтобы проверить активные подписки, добавьте к предыдущему скрипту следующий код:</span><span class="sxs-lookup"><span data-stu-id="341ed-220">To check your active subscriptions, add the following to the previous script:</span></span>

```powershell
Invoke-WebRequest -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/list" 
```

#### <a name="sample-response"></a><span data-ttu-id="341ed-221">Пример отклика</span><span class="sxs-lookup"><span data-stu-id="341ed-221">Sample response</span></span>

```json
StatusCode        : 200
Status Description : OK
Content           : [{"contentType":"Audit.Exchange","status":"enabled","webhook":null},{"contentType":"Audit.SharePoint","status":"enabled","webhook":{"authId":"","address":"https://mvcwebapiwebhookreceiver.azurewebsite...
RawContent        : HTTP/1.1 200 OK
                    Pragma: no-cache
                    Content-Length: 266
                    Cache-Control: no-cache
                    Content-Type: application/json; charset=utf-8
                    Expires: -1
                    Server: Microsoft-IIS/8.5,Microsoft-IIS/8.5
                    X-AspNet-Versi...
Forms             : {}
Headers           : {[Pragma, no-cache], [Content-Length, 266], [Cache-Control, no-cache], [Content-Type, application/json; charset=utf-8]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 266
```

<span data-ttu-id="341ed-222">Это означает, что для клиента включены подписки Audit.Exchange и Audit.SharePoint.</span><span class="sxs-lookup"><span data-stu-id="341ed-222">This says that the tenant has both Audit.Exchange and Audit.SharePoint subscriptions enabled.</span></span> <span data-ttu-id="341ed-223">Для подписки Exchange веб-перехватчик не включен (null), а для подписки SharePoint включен веб-перехватчик с адресом зарегистрированной конечной точки.</span><span class="sxs-lookup"><span data-stu-id="341ed-223">The Exchange subscription has no webhook enabled (null) and the SharePoint subscription has a webhook enabled with the address of the registered endpoint shown.</span></span>

### <a name="creating-a-new-subscription"></a><span data-ttu-id="341ed-224">Создание новой подписки</span><span class="sxs-lookup"><span data-stu-id="341ed-224">Creating a new subscription</span></span>

<span data-ttu-id="341ed-225">Чтобы создать новую подписку, используйте операцию /start.</span><span class="sxs-lookup"><span data-stu-id="341ed-225">To create a new subscription, you use the /start operation.</span></span> <span data-ttu-id="341ed-226">Для конечной точки API используйте одно из указанных ниже значений в зависимости от плана подписки:</span><span class="sxs-lookup"><span data-stu-id="341ed-226">For the API endpoint, use one of these values base on your subscription plan:</span></span>

- <span data-ttu-id="341ed-227">План для предприятий: `manage.office.com`</span><span class="sxs-lookup"><span data-stu-id="341ed-227">Enterprise plan: `manage.office.com`</span></span>

- <span data-ttu-id="341ed-228">План для государственных организаций (GCC): `manage-gcc.office.com`</span><span class="sxs-lookup"><span data-stu-id="341ed-228">GCC government plan: `manage-gcc.office.com`</span></span>

- <span data-ttu-id="341ed-229">План для государственных организаций (GCC High): `manage.office365.us`</span><span class="sxs-lookup"><span data-stu-id="341ed-229">GCC High government plan: `manage.office365.us`</span></span>

- <span data-ttu-id="341ed-230">План для государственных организаций (DoD): `manage.protection.apps.mil`</span><span class="sxs-lookup"><span data-stu-id="341ed-230">DoD government plan: `manage.protection.apps.mil`</span></span>

```powershell
Invoke-WebRequest -Method Post -Headers $headerParams -Uri "https://<YOUR_API_ENDPOINT>/api/v1.0/$tenantGUID/activity/feed/subscriptions/start?contentType=Audit.AzureActiveDirectory"

> [!NOTE]
> Remember that `$headerParams` was populated in the first part of the script listed in the [Connecting to the API](#connecting-to-the-api) section in this article.

The previous code will create a new subscription to the Audit.AzureActiveDirectory content type, with a webhook that is null. You can then check your subscriptions using the code in the [Checking your subscriptions](#checking-your-subscriptions) section in this article.

## Checking content availability

To check what content blobs were created during a certain period, you can add the following line to the script in the “Connecting to the API” section.

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint"
```

<span data-ttu-id="341ed-231">В приведенном выше примере показано, как получить все уведомления о контенте, который стал доступен сегодня, то есть с 12:00 (в формате UTC) по текущее время.</span><span class="sxs-lookup"><span data-stu-id="341ed-231">The previous example will get all the content notifications that became available today, which means from 12:00 AM UTC to the current time.</span></span> <span data-ttu-id="341ed-232">Если вы хотите указать другой временной период (учитывая, что максимальный период запроса составляет 24 часа), добавьте параметры *starttime* и *endtime* к URI. Пример:</span><span class="sxs-lookup"><span data-stu-id="341ed-232">If you want to specify a different time period (keeping in mind that the maximum period for which you can query is 24 hours), add the *starttime* and *endtime* parameters to the URI; for example:</span></span>

```powershell
Invoke-WebRequest -Method GET -Headers $headerParams -Uri "$resource/api/v1.0/$tenantGUID/activity/feed/subscriptions/content?contentType=Audit.SharePoint&startTime=2017-10-13T00:00&endTime=2017-10-13T11:59"
```

> [!NOTE]
> <span data-ttu-id="341ed-233">Необходимо либо указать параметры *starttime* и *endtime*, либо не указывать ни одного из них.</span><span class="sxs-lookup"><span data-stu-id="341ed-233">You must use either both *starttime* and *endtime* parameters or neither.</span></span>

```json
[{      "contentUri" : "https://<your_API_endpoint>/api/v1.0/<your_tenant_guid>/activity/feed/audit/20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentId" : "20171014180051748005825$20171014180051748005825$audit_sharepoint$Audit_SharePoint",
        "contentType" : "Audit.SharePoint",
        "contentCreated" : "2017-10-13T18:00:51.748Z",
        "contentExpiration" : "2017-10-20T18:00:51.748Z",
}]
```

> [!IMPORTANT]
>
> - <span data-ttu-id="341ed-234">Свойство *contentUri* — это URI, из которого можно получить большой двоичный объект с контентом.</span><span class="sxs-lookup"><span data-stu-id="341ed-234">The *contentUri* property is the URI from which you can retrieve the content blob.</span></span> <span data-ttu-id="341ed-235">Сам объект содержит сведения о 1–N событиях.</span><span class="sxs-lookup"><span data-stu-id="341ed-235">The blob itself is what contains the event details; it will contain details about 1 – N events.</span></span> <span data-ttu-id="341ed-236">Коллекция может содержать до 30 объектов JSON, но в этих 30 URI контента может быть указано намного больше событий.</span><span class="sxs-lookup"><span data-stu-id="341ed-236">While there may be 30 JSON objects in the collection, there may be many more events detailed in those 30 content URIs.</span></span>
>
> - <span data-ttu-id="341ed-237">Свойство *contentCreated* — это не дата создания события, соответствующего уведомлению.</span><span class="sxs-lookup"><span data-stu-id="341ed-237">The *contentCreated* property is not the date that the event being notified was created.</span></span> <span data-ttu-id="341ed-238">Это дата создания уведомления.</span><span class="sxs-lookup"><span data-stu-id="341ed-238">This is the date the notification was created.</span></span> <span data-ttu-id="341ed-239">События, описываемые в большом двоичном объекте, могли быть созданы задолго до создания самого объекта.</span><span class="sxs-lookup"><span data-stu-id="341ed-239">The events detailed in that blob may have been created well before the content blob was created.</span></span> <span data-ttu-id="341ed-240">Следовательно, из API невозможно напрямую запрашивать события, произошедшие за тот или иной период.</span><span class="sxs-lookup"><span data-stu-id="341ed-240">Therefore, you can never query the API directly for events that occurred within any given period.</span></span>

#### <a name="paging-contents-for-busy-tenants"></a><span data-ttu-id="341ed-241">Разбиение контента на страницы для нагруженных клиентов</span><span class="sxs-lookup"><span data-stu-id="341ed-241">Paging contents for busy tenants</span></span>

<span data-ttu-id="341ed-242">Во многих крупных клиентах Office 365 каждый час происходят тысячи событий.</span><span class="sxs-lookup"><span data-stu-id="341ed-242">Many larger Office 365 tenants have thousands of events being generated every hour.</span></span> <span data-ttu-id="341ed-243">Если это верно для вашей организации, при попытке выполнить запрос для 24-часового периода, как в приведенном выше примере, может потребоваться получить больше уведомлений, чем можно вернуть в одном отклике.</span><span class="sxs-lookup"><span data-stu-id="341ed-243">If this is the case with your organization, and you try to execute a query for a 24-hour period like in the example above, you may need to retrieve more notifications than can be returned in one response.</span></span> <span data-ttu-id="341ed-244">В этом случае вам потребуется реализовать некий логический цикл, каждый раз проверяя заголовки отклика на наличие значения заголовка **NextPageUrl:**.</span><span class="sxs-lookup"><span data-stu-id="341ed-244">In this case, you'll need to implement a logical loop of some kind, each time checking the response headers for the **NextPageUrl:** header value.</span></span> <span data-ttu-id="341ed-245">Дополнительные сведения см. в разделе "Разбивка на страницы" справочника по API действий управления Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-245">See the Pagination section in the Office 365 Management Activity API reference for more details.</span></span>

```powershell
IF the NextPageUrl header is present in the response... 

THEN issue a new request substituting the Uri parameter in the above Invoke-WebRequest example for the value of the NextPageUrl header...
 
ELSE exit the loop
```

<span data-ttu-id="341ed-246">Этот повторяющийся код будет сложно тестировать, если у вас не очень активный клиент.</span><span class="sxs-lookup"><span data-stu-id="341ed-246">It will be difficult to test this looping code unless you have a very active tenant.</span></span> <span data-ttu-id="341ed-247">В нашем тесте мы попытались выполнить в скрипте несколько тысяч операций обновления и не смогли создать достаточно большое количество уведомлений, чтобы потребовалось отправлять заголовок **NextPageUrl**.</span><span class="sxs-lookup"><span data-stu-id="341ed-247">In our testing, we tried to execute several thousand update operations in a script and was unable to generate a large enough number of notifications to require the **NextPageUrl** header to be sent.</span></span>

### <a name="using-webhooks"></a><span data-ttu-id="341ed-248">Использование веб-перехватчиков</span><span class="sxs-lookup"><span data-stu-id="341ed-248">Using webhooks</span></span>

<span data-ttu-id="341ed-249">Уведомление о создании больших двоичных объектов с контентом можно получить двумя способами.</span><span class="sxs-lookup"><span data-stu-id="341ed-249">There two ways to get a notification that content blobs have been created.</span></span> <span data-ttu-id="341ed-250">Подход с *отправкой* реализован при помощи конечной точки веб-перехватчика — веб-приложения, которое вы создаете и размещаете самостоятельно или на облачной платформе.</span><span class="sxs-lookup"><span data-stu-id="341ed-250">The *push* approach is implemented with a webhook endpoint, which is a web application that you create and host yourself or on a cloud platform.</span></span> <span data-ttu-id="341ed-251">Веб-перехватчик регистрируется во время создания подписки на тип контента для аудита.</span><span class="sxs-lookup"><span data-stu-id="341ed-251">You register the webhook at the time you create a subscription to an audited content type.</span></span> <span data-ttu-id="341ed-252">Вы также можете добавить регистрацию веб-перехватчика к имеющейся подписке, используя показанный ниже подход.</span><span class="sxs-lookup"><span data-stu-id="341ed-252">You may also add a webhook registration to an existing subscription using the approach shown below.</span></span> <span data-ttu-id="341ed-253">Подход *pull* требует запрашивать данные за определенный временной диапазон (не более 24 часов) с помощью операции /content.</span><span class="sxs-lookup"><span data-stu-id="341ed-253">The *pull* approach requires you to query for a particular timespan (no more than 24 hours) using the /content operation.</span></span> <span data-ttu-id="341ed-254">В отклике будет указано, какие большие двоичные объекты были созданы за указанный период.</span><span class="sxs-lookup"><span data-stu-id="341ed-254">The response will tell you which content blobs were created during the period specified.</span></span>

<span data-ttu-id="341ed-255">Прежде чем добавлять веб-перехватчик, учтите следующие две проблемы:</span><span class="sxs-lookup"><span data-stu-id="341ed-255">Before you add a webhook, be aware of the following two issues:</span></span>

1. <span data-ttu-id="341ed-256">Корпорация Майкрософт отходит от использования веб-перехватчиков из-за сложности отладки и устранения неполадок.</span><span class="sxs-lookup"><span data-stu-id="341ed-256">Webhooks are being de-emphasized by Microsoft because of the difficulty in debugging and troubleshooting.</span></span> <span data-ttu-id="341ed-257">Как правило, размещается конечная точка WebApi, отвечающая на входящие запросы.</span><span class="sxs-lookup"><span data-stu-id="341ed-257">Typically, you would host a WebApi endpoint that responds to incoming requests.</span></span> <span data-ttu-id="341ed-258">Многие клиенты используют либо среды внешнего размещения (которые они не полностью контролируют), либо локальные среды (которые с трудом пропускают входящие HTTP-запросы).</span><span class="sxs-lookup"><span data-stu-id="341ed-258">Many customers either use hosting environments (which they don't have full control over) or on-premises environments (that have difficulty allowing incoming HTTP requests).</span></span> <span data-ttu-id="341ed-259">Сотрудники службы поддержки часто сталкиваются с проблемами, когда входящие запросы из конвейера аудита Office 365 блокируются брандмауэром или маршрутизатором.</span><span class="sxs-lookup"><span data-stu-id="341ed-259">Support has seen many problems where the incoming requests from the Office 365 auditing pipeline have been blocked by a firewall or router.</span></span> <span data-ttu-id="341ed-260">В этом случае API реализует алгоритм отхода, который может быть запутанным и приводить к отключению веб-перехватчика в подписке.</span><span class="sxs-lookup"><span data-stu-id="341ed-260">In this case, the API will implement a back-off algorithm, which can be confusing and may result in disabling the webhook in the subscription.</span></span>

2. <span data-ttu-id="341ed-261">Веб-перехватчик должен быть готов сразу ответить на отклик о проверке после выполнения операции запуска.</span><span class="sxs-lookup"><span data-stu-id="341ed-261">The webhook must be ready to immediately respond to a validation request after the start operation is executed.</span></span> <span data-ttu-id="341ed-262">Если в приложении веб-перехватчика возникнет ошибка, то проверка завершится сбоем, а веб-перехватчик не будет включен.</span><span class="sxs-lookup"><span data-stu-id="341ed-262">If there is a bug in the webhook application, the validation will fail, and the webhook will not be enabled.</span></span> <span data-ttu-id="341ed-263">Сведения о схеме запросов на проверку см. в разделе "Проверка веб-перехватчиков" справочника по API действий управления Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-263">For information about the validation request schema, see the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="341ed-264">Вам следует серьезно отнестись к трудностям при создании готового к работе веб-перехватчика для ответа на уведомления API действий управления.</span><span class="sxs-lookup"><span data-stu-id="341ed-264">You should seriously consider the challenges in producing a production-ready webhook to respond to Management Activity API notifications.</span></span>

<span data-ttu-id="341ed-265">Если вы решите реализовать веб-перехватчик, его следует протестировать, чтобы убедиться, что конечная точка готова вернуть отклик HTTP 200 как на запрос проверки, так и на обычные запросы уведомлений перед операцией /start, указывающей, что конечная точка веб-перехватчика вызывается впервые.</span><span class="sxs-lookup"><span data-stu-id="341ed-265">If you decide to implement a webhook, it should be tested to verify that the endpoint is prepared to respond with an HTTP 200 response to both the validation request and the normal notification requests before any /start operation that specifies a webhook endpoint is called for the first time.</span></span> <span data-ttu-id="341ed-266">Как правило, для тестирования готовности используется макет запроса от API.</span><span class="sxs-lookup"><span data-stu-id="341ed-266">Typically, you would use a mocked request from the API to test this readiness.</span></span> <span data-ttu-id="341ed-267">Внимательно прочтите и соблюдайте инструкции из разделов Проверка веб-перехватчиков и Получение контента справочника по API действий управления Office 365, чтобы понять схему запросов этих двух типов.</span><span class="sxs-lookup"><span data-stu-id="341ed-267">Carefully read and observe both the Webhook validation and Retrieving content sections in the Office 365 Management Activity API reference to understand the schema of these two types of requests.</span></span>

<span data-ttu-id="341ed-268">Чтобы добавить подписку с конечной точкой веб-перехватчика, добавьте параметр body в запрос POST к конечной точке /start. Пример:</span><span class="sxs-lookup"><span data-stu-id="341ed-268">To add a subscription with a webhook endpoint, add a body parameter to the POST to the /start endpoint; for example:</span></span>

```json
$body = '{
    "webhook" : {
        "address": "https://webhook.myapp.com/o365/",
        "authId": "o365activityapinotification",
        "expiration": ""
    }}'
$uri = "https://manage.office.com/api/v1.0/$tenantGUID/activity/feed//subscriptions/start?contentType=Audit.SharePoint"
Invoke-RestMethod -Method Post -uri $uri -Headers $headerParams -Body $body
```

<span data-ttu-id="341ed-269">Сразу после этого вызова будет отправлен запрос на проверку по адресу `https://webhook.myapp.com/o365/ …`, где должен находиться готовый к ответу прослушиватель, как описано в разделе Проверка веб-перехватчиков справочника по API действий управления Office 365.</span><span class="sxs-lookup"><span data-stu-id="341ed-269">Immediately following this call, a validation request will be sent out to `https://webhook.myapp.com/o365/ …` and there should be a listener ready to respond, as per the description in the Webhook validation section in the Office 365 Management Activity API reference.</span></span> <span data-ttu-id="341ed-270">В ответ прослушиватель отправит отклик HTTP 200.</span><span class="sxs-lookup"><span data-stu-id="341ed-270">Your listener must respond with HTTP 200.</span></span> <span data-ttu-id="341ed-271">Если сразу после этого выполнить операцию /list, вы не увидите никакого значения параметра webhook, кроме null, пока результаты проверки не будут успешно возвращены.</span><span class="sxs-lookup"><span data-stu-id="341ed-271">If you immediately run the /list operation at this point, you will not see the webhook shown as other than null until the validation has returned successfully.</span></span>

#### <a name="checking-notifications-to-webhooks"></a><span data-ttu-id="341ed-272">Проверка уведомлений для веб-перехватчиков</span><span class="sxs-lookup"><span data-stu-id="341ed-272">Checking notifications to webhooks</span></span>

<span data-ttu-id="341ed-273">Важно понимать разницу между операциями /notifications и /content.</span><span class="sxs-lookup"><span data-stu-id="341ed-273">It's important to distinguish between the /notifications operation and the /content operation.</span></span> <span data-ttu-id="341ed-274">Проверка уведомлений уместна только при наличии подписки на конечную точку веб-перехватчика.</span><span class="sxs-lookup"><span data-stu-id="341ed-274">Checking notifications is only relevant if you have subscribed with a webhook endpoint.</span></span> <span data-ttu-id="341ed-275">Эта операция сообщит вам, были ли успешными попытки отправки уведомлений вашему веб-перехватчику.</span><span class="sxs-lookup"><span data-stu-id="341ed-275">This operation will let you know if attempts to send notifications to your webhook have been successful or not.</span></span> <span data-ttu-id="341ed-276">Эту операцию не следует использовать для получения списка доступного контента.</span><span class="sxs-lookup"><span data-stu-id="341ed-276">This operation should not be used to list available content.</span></span> <span data-ttu-id="341ed-277">Для перекрестной проверки доступности контента относительно данных, уже полученных веб-перехватчиком, следует использовать операцию /content.</span><span class="sxs-lookup"><span data-stu-id="341ed-277">To cross-check the availability of content against what you may have already received in your webhook, you would use the /content operation.</span></span> <span data-ttu-id="341ed-278">Но сначала следует проверить наличие неудачных уведомлений с помощью операции /notifications.</span><span class="sxs-lookup"><span data-stu-id="341ed-278">But be sure to first check for failed notifications using the /notifications operation.</span></span>

### <a name="requesting-content-blobs-and-throttling"></a><span data-ttu-id="341ed-279">Запрос больших двоичных объектов с контентом и регулирование</span><span class="sxs-lookup"><span data-stu-id="341ed-279">Requesting content blobs and throttling</span></span>

<span data-ttu-id="341ed-280">Получив список URI контента, необходимо запросить объекты, указанные этими URI.</span><span class="sxs-lookup"><span data-stu-id="341ed-280">After you've obtained a list of content URIs, you must request the blobs specified by the URIs.</span></span> <span data-ttu-id="341ed-281">Ниже приведен пример запроса большого двоичного объекта с контентом (с использованием конечной точки API manage.office.com для организаций с планом для предприятий) с помощью PowerShell.</span><span class="sxs-lookup"><span data-stu-id="341ed-281">The following is an example of requesting a content blob (using the manage.office.com API endpoint for Enterprise organizations) using PowerShell.</span></span> <span data-ttu-id="341ed-282">В этом примере предполагается, что вы уже использовали предыдущий пример из раздела [Получение маркера доступа](#getting-an-access-token) этой статьи, чтобы получить маркер доступа, и заполнили переменную `$headerParams` должным образом.</span><span class="sxs-lookup"><span data-stu-id="341ed-282">This example assumes you have already used the previous example in the [Getting an access token](#getting-an-access-token) section in this article to get an access token and have populated the `$headerParams` variable appropriately.</span></span>

```powershell
# Get a content blob
$uri = 'https://manage.office.com/api/v1.0/<<your-tenant-guid>>/activity/feed/audit/<<ContentID>$audit_sharepoint$Audit_SharePoint'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="341ed-283">Обратите внимание на следующие особенности переменной *$uri* в предыдущем примере:</span><span class="sxs-lookup"><span data-stu-id="341ed-283">Note the following things about the *$uri* variable in the previous example:</span></span>

- <span data-ttu-id="341ed-284">Мы использовали одинарные кавычки, чтобы среда PowerShell не интерпретировала символы *$* как переменные.</span><span class="sxs-lookup"><span data-stu-id="341ed-284">We used single quotes so that the *$* symbols aren't interpreted as variables in PowerShell</span></span>

- <span data-ttu-id="341ed-285">Весь URI будет возвращен в свойстве *contentUri* отклика на предыдущий вызов конечной точки /content.</span><span class="sxs-lookup"><span data-stu-id="341ed-285">The entire URI will be returned in the *contentUri* property of the response to your previous call to the /content endpoint.</span></span> <span data-ttu-id="341ed-286">Маркеры-заполнители представлены исключительно для примера.</span><span class="sxs-lookup"><span data-stu-id="341ed-286">The placeholder tokens shown are just for illustration.</span></span>

<span data-ttu-id="341ed-287">При попытке получить доступные большие двоичные объекты многие пользователи (особенно работающие с нагруженными клиентами) сталкивались примерно с такими ошибками:</span><span class="sxs-lookup"><span data-stu-id="341ed-287">When attempting to retrieve the available content blobs, many customers (mostly working with busy tenants) have experienced errors that look like this:</span></span>

```json
Response Code 403: {'error':{'code':'AF429','message':'Too many requests. Method=GetBlob, PublisherId=00000000-0000-0000-0000-000000000000'}}
```

<span data-ttu-id="341ed-288">Скорее всего, это вызвано регулированием.</span><span class="sxs-lookup"><span data-stu-id="341ed-288">This is likely due to throttling.</span></span> <span data-ttu-id="341ed-289">Обратите внимание, что значение параметра PublisherId с большой вероятностью указывает, что клиент не указал параметр *PublisherIdentifier* в запросе.</span><span class="sxs-lookup"><span data-stu-id="341ed-289">Note that the value of the PublisherId parameter likely indicates that the client didn't specify the *PublisherIdentifier* in the request.</span></span> <span data-ttu-id="341ed-290">Кроме того, учтите, что правильное имя параметра — *PublisherIdentifier*, несмотря на то что в откликах об ошибке 403 указывается имя *PublisherId*.</span><span class="sxs-lookup"><span data-stu-id="341ed-290">Also, keep in mind that the correct parameter name is *PublisherIdentifier* even though you see *PublisherId* listed in the 403 error responses.</span></span>

> [!NOTE]
> <span data-ttu-id="341ed-291">В справочнике по API параметр *PublisherIdentifier* указан в каждой операции API, но его также следует включить в запрос GET к URL-адресу contentUri при получении объекта с контентом.</span><span class="sxs-lookup"><span data-stu-id="341ed-291">In the API reference, the *PublisherIdentifier* parameter is listed in every operation of the API, but it should also be included in the GET request to the contentUri URL when retrieving the content blob.</span></span>

<span data-ttu-id="341ed-292">Если вы совершаете простые вызовы API для устранения неполадок (например, проверяете, активна ли определенная подписка), вы можете спокойно пропускать параметр *PublisherIdentifier*, но любой код, рассчитанный на рабочую среду, обязательно должен включать параметр *PublisherIdentifier* в каждый вызов.</span><span class="sxs-lookup"><span data-stu-id="341ed-292">If you're doing simple API calls to troubleshoot problems (for example, checking if a given subscription is active) you can safely omit the *PublisherIdentifier* parameter, but absolutely any code that is eventually meant for production use should include the *PublisherIdentifier* parameter on every call.</span></span>

<span data-ttu-id="341ed-293">Если вы реализуете клиентское приложение для клиента компании, то *PublisherIdentifier* — это GUID клиента.</span><span class="sxs-lookup"><span data-stu-id="341ed-293">If you're implementing a client for your company's tenant, the *PublisherIdentifier* is the Tenant GUID.</span></span> <span data-ttu-id="341ed-294">Если вы создаете приложение или надстройку для нескольких пользователей как независимый поставщик программного обеспечения, то параметр *PublisherIdentifier* должен содержать GUID клиента независимого поставщика, а не GUID клиента компании пользователя.</span><span class="sxs-lookup"><span data-stu-id="341ed-294">If you are creating an ISV application or add-in for multiple customers, the *PublisherIdentifier* should be the ISV's Tenant GUID, and not the tenant GUID of end user's company.</span></span>

<span data-ttu-id="341ed-295">Включив допустимый параметр *PublisherIdentifier*, вы получите пул, поддерживающий до 60 тысяч запросов в минуту для каждого клиента.</span><span class="sxs-lookup"><span data-stu-id="341ed-295">If you include the valid *PublisherIdentifier*, then you will be in a pool that is allotted 60K requests per minute per tenant.</span></span> <span data-ttu-id="341ed-296">Это исключительно большое количество запросов.</span><span class="sxs-lookup"><span data-stu-id="341ed-296">This is an exceptionally large number of requests.</span></span> <span data-ttu-id="341ed-297">Однако если не включить параметр *PublisherIdentifier*, вам будет предоставлен общий пул, рассчитанный на 60 тысяч запросов в минуту для всех клиентов.</span><span class="sxs-lookup"><span data-stu-id="341ed-297">However, if you don't include the *PublisherIdentifier* parameter, you will be in the general pool allotted 60K requests per minute for all tenants.</span></span> <span data-ttu-id="341ed-298">В этом случае ваши вызовы наверняка будут регулироваться.</span><span class="sxs-lookup"><span data-stu-id="341ed-298">In this case, you will more than likely find that your calls are getting throttled.</span></span> <span data-ttu-id="341ed-299">Во избежание этого вы можете запросить большой двоичный объект с контентом при помощи параметра *PublisherIdentifier* следующим образом:</span><span class="sxs-lookup"><span data-stu-id="341ed-299">To prevent this, here's how you would request a content blob using the *PublisherIdentifier*:</span></span>

```json
$contentUri = ($response.Content | ConvertFrom-Json).contentUri[0]
$uri = $contentUri + '?PublisherIdentifier=82b24b6d-0591-4604-827b-705d55d0992f'
$contents = Invoke-WebRequest -Method GET -Headers $headerParams -Uri $uri
```

<span data-ttu-id="341ed-300">В предыдущем примере предполагается, что переменная *$response* содержит отклик на запрос к конечной точке /content, а переменная *$headerParams* включает действительный маркер доступа.</span><span class="sxs-lookup"><span data-stu-id="341ed-300">The previous example assumes that the *$response* variable was populated with the response to a request to the /content endpoint and that the *$headerParams* variable includes a valid access token.</span></span> <span data-ttu-id="341ed-301">Скрипт получает из отклика первый элемент массива URI контента, а затем отправляет запрос GET, чтобы скачать этот объект и добавить переменную *$contents*.</span><span class="sxs-lookup"><span data-stu-id="341ed-301">The script grabs the first item in the array of content URIs from the response and then invokes the GET to download that blob and put it in the *$contents* variable.</span></span> <span data-ttu-id="341ed-302">Скорее всего, код циклически просмотрит коллекцию contentUri, отправляя запрос GET для каждого значения *contentUri*.</span><span class="sxs-lookup"><span data-stu-id="341ed-302">Your code will likely loop through the contentUri collection, issuing the GET for each *contentUri*.</span></span>
